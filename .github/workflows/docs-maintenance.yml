name: Documentation Maintenance

on:
  workflow_dispatch:
    inputs:
      auto_fix:
        description: "Apply automatic docs fixes before checks"
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 2 * * 1"
  push:
    branches: [main, develop]
    paths:
      - "docs/**"
      - "**.md"
      - "scripts/documentation/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "docs/**"
      - "**.md"
      - "scripts/documentation/**"

jobs:
  docs-maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install docs dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      - name: Optional auto-fix
        if: github.event_name == 'workflow_dispatch' && inputs.auto_fix == true
        run: make docs DOCS_PHASE=fix FIX=1 PROJECT=flext-api

      - name: Run documentation audit
        run: make docs DOCS_PHASE=audit PROJECT=flext-api

      - name: Run strict docs build
        run: make docs DOCS_PHASE=build PROJECT=flext-api

      - name: Run docs validation
        run: make docs DOCS_PHASE=validate PROJECT=flext-api

      - name: Upload docs reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: docs-maintenance-reports-${{ github.run_id }}
          path: .reports/docs/
          retention-days: 30

      - name: Comment on PR with docs summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const summaryPath = '.reports/docs/validate-summary.json';
            let body = '## Documentation Maintenance Results\n\n';

            if (fs.existsSync(summaryPath)) {
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              body += `- Result: ${summary.summary?.result || 'unknown'}\n`;
              body += `- Scope: ${summary.summary?.scope || 'unknown'}\n`;
              body += `- Message: ${summary.summary?.message || 'n/a'}\n`;
            } else {
              body += '- Validation summary not found in `.reports/docs/validate-summary.json`.\n';
            }

            body += `\n[View workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
