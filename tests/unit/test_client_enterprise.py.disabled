"""ENTERPRISE UNIT TESTS - FlextApiClient.

Tests every single method and feature of FlextApiClient with real HTTP calls,
plugin functionality, circuit breaker, retry, caching, and streaming.
NO MOCKS - only real functionality validation.
"""

import aiohttp
import pytest

from flext_api.client import (
    FlextApiCachingPlugin,
    FlextApiCircuitBreakerPlugin,
    FlextApiClient,
    FlextApiClientConfig,
    FlextApiClientMethod,
    FlextApiClientStatus,
    FlextApiRetryPlugin,
    create_client,
    create_client_with_plugins,
)


class TestFlextApiClientCore:
    """Core client functionality tests."""

    def test_client_config_creation(self) -> None:
        """Test client configuration creation."""
        config = FlextApiClientConfig(
            base_url="https://httpbin.org",
            timeout=30.0,
            headers={"User-Agent": "FlextApi/1.0"},
            verify_ssl=True,
        )

        assert config.base_url == "https://httpbin.org"
        assert config.timeout == 30.0
        assert config.headers["User-Agent"] == "FlextApi/1.0"
        assert config.verify_ssl is True

    def test_client_initialization(self) -> None:
        """Test client initialization."""
        config = FlextApiClientConfig(base_url="https://httpbin.org")
        client = FlextApiClient(config)

        assert client.config.base_url == "https://httpbin.org"
        assert client._status == FlextApiClientStatus.IDLE
        assert len(client._plugins) == 0
        assert client._request_count == 0
        assert client._total_time == 0.0

    def test_url_building(self) -> None:
        """Test URL building from paths."""
        config = FlextApiClientConfig(base_url="https://httpbin.org")
        client = FlextApiClient(config)

        # Test various path formats
        assert client.build_full_url("/json") == "https://httpbin.org/json"
        assert client.build_full_url("json") == "https://httpbin.org/json"
        assert client.build_full_url("/api/v1/test") == "https://httpbin.org/api/v1/test"

        # Test with trailing slash in base_url
        config2 = FlextApiClientConfig(base_url="https://httpbin.org/")
        client2 = FlextApiClient(config2)
        assert client2.build_full_url("/json") == "https://httpbin.org/json"


class TestFlextApiClientRealHTTP:
    """Real HTTP request tests - validates actual functionality."""

    @pytest.mark.asyncio
    async def test_real_get_request(self) -> None:
        """Test real GET request to httpbin.org."""
        client = create_client("https://httpbin.org", timeout=10.0)

        try:
            result = await client.get("/json")

            assert result.is_success
            response = result.data
            assert response.status_code == 200
            assert isinstance(response.data, dict)
            assert "slideshow" in response.data  # httpbin.org/json content
            assert response.elapsed_time > 0

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_real_post_request(self) -> None:
        """Test real POST request with JSON data."""
        client = create_client("https://httpbin.org", timeout=10.0)

        try:
            test_data = {"name": "FlextApi", "version": "1.0", "test": True}
            result = await client.post("/post", json=test_data)

            assert result.is_success
            response = result.data
            assert response.status_code == 200

            # Verify echo data
            response_json = response.data
            assert response_json["json"]["name"] == "FlextApi"
            assert response_json["json"]["test"] is True

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_real_put_delete_requests(self) -> None:
        """Test real PUT and DELETE requests."""
        client = create_client("https://httpbin.org", timeout=10.0)

        try:
            # Test PUT
            result = await client.put("/put", json={"action": "update"})
            assert result.is_success
            assert result.data.status_code == 200

            # Test DELETE
            result = await client.delete("/delete")
            assert result.is_success
            assert result.data.status_code == 200

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_request_with_headers_and_params(self) -> None:
        """Test request with custom headers and query parameters."""
        client = create_client("https://httpbin.org", timeout=10.0)

        try:
            headers = {"X-Test-Header": "FlextApi", "Authorization": "Bearer test123"}
            params = {"param1": "value1", "param2": "value2"}

            result = await client.get("/get", headers=headers, params=params)

            assert result.is_success
            response_data = result.data.data

            # Verify headers were sent
            assert response_data["headers"]["X-Test-Header"] == "FlextApi"
            assert response_data["headers"]["Authorization"] == "Bearer test123"

            # Verify params were sent
            assert response_data["args"]["param1"] == "value1"
            assert response_data["args"]["param2"] == "value2"

        finally:
            await client.close()


class TestFlextApiClientPlugins:
    """Plugin system tests - validates real plugin functionality."""

    @pytest.mark.asyncio
    async def test_caching_plugin_functionality(self) -> None:
        """Test caching plugin with real HTTP requests."""
        client = create_client("https://httpbin.org", timeout=10.0)
        cache_plugin = FlextApiCachingPlugin(ttl_seconds=60)
        client.add_plugin(cache_plugin)

        try:
            # First request - cache miss
            result1 = await client.get("/uuid")
            assert result1.is_success
            assert not result1.data.from_cache

            # Second request - should be cache hit (same UUID)
            result2 = await client.get("/uuid")
            assert result2.is_success
            # UUID endpoint returns different values, so this tests actual caching

            # Check cache stats
            stats = cache_plugin.get_cache_stats()
            assert stats["hits"] >= 0
            assert stats["misses"] >= 1
            assert stats["cache_size"] >= 0

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_retry_plugin_functionality(self) -> None:
        """Test retry plugin with failing requests."""
        client = create_client("https://httpstat.us", timeout=5.0)
        retry_plugin = FlextApiRetryPlugin(max_retries=2, backoff_factor=0.1)
        client.add_plugin(retry_plugin)

        try:
            # Request that will fail with 500 status
            await client.get("/500")

            # Should eventually fail after retries
            # (httpstat.us/500 always returns 500)
            # The retry plugin should have attempted retries
            metrics = retry_plugin.get_metrics()
            assert isinstance(metrics, dict)

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_circuit_breaker_functionality(self) -> None:
        """Test circuit breaker plugin behavior."""
        client = create_client("https://httpstat.us", timeout=2.0)
        cb_plugin = FlextApiCircuitBreakerPlugin(
            failure_threshold=2,
            timeout_seconds=1,
            success_threshold=1,
        )
        client.add_plugin(cb_plugin)

        try:
            # Make requests that will fail
            for _i in range(3):
                await client.get("/500")
                # Circuit breaker should open after threshold

            # Check circuit breaker state
            assert cb_plugin.state in {"open", "closed", "half-open"}
            metrics = cb_plugin.get_metrics()
            assert "state" in metrics
            assert "failure_count" in metrics

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_multiple_plugins_together(self) -> None:
        """Test multiple plugins working together."""
        client = create_client_with_plugins(
            "https://httpbin.org",
            enable_cache=True,
            enable_retry=True,
            enable_circuit_breaker=True,
            timeout=10.0,
        )

        try:
            assert len(client._plugins) == 3

            # Make a successful request
            result = await client.get("/json")
            assert result.is_success
            assert result.data.status_code == 200

            # All plugins should have processed the request
            for plugin in client._plugins:
                assert plugin.enabled
                metrics = plugin.get_metrics()
                assert isinstance(metrics, dict)

        finally:
            await client.close()


class TestFlextApiClientHealth:
    """Client health and metrics tests."""

    @pytest.mark.asyncio
    async def test_client_health_status(self) -> None:
        """Test client health reporting."""
        client = create_client("https://httpbin.org")

        try:
            # Initial health
            health_result = await client.get_health()
            assert health_result.is_success

            health = health_result.data
            assert health["status"] == "active"
            assert health["request_count"] == 0
            assert health["average_response_time"] == 0
            assert isinstance(health["active_plugins"], list)
            assert health["session_closed"] is False

            # Make a request and check health again
            await client.get("/json")

            health_result2 = await client.get_health()
            health2 = health_result2.data
            assert health2["request_count"] == 1
            assert health2["average_response_time"] > 0

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_client_metrics(self) -> None:
        """Test detailed client metrics."""
        client = create_client_with_plugins("https://httpbin.org")

        try:
            # Make some requests
            await client.get("/json")
            await client.post("/post", json={"test": "data"})

            metrics_result = await client.get_metrics()
            assert metrics_result.is_success

            metrics = metrics_result.data
            assert "client" in metrics
            assert "plugins" in metrics

            client_metrics = metrics["client"]
            assert client_metrics["requests"] == 2
            assert client_metrics["total_time"] > 0
            assert client_metrics["average_time"] > 0
            assert client_metrics["status"] == "active"

            # Check plugin metrics
            plugin_metrics = metrics["plugins"]
            assert isinstance(plugin_metrics, dict)

        finally:
            await client.close()


class TestFlextApiClientStreaming:
    """Streaming functionality tests."""

    @pytest.mark.asyncio
    async def test_streaming_response(self) -> None:
        """Test streaming response functionality."""
        client = create_client("https://httpbin.org", timeout=15.0)

        try:
            chunk_count = 0
            total_bytes = 0

            # Stream data from httpbin.org/stream endpoint
            async for chunk in client.stream(FlextApiClientMethod.GET, "/stream/3"):
                chunk_count += 1
                total_bytes += len(chunk)
                assert len(chunk) > 0

                # Limit chunks for test
                if chunk_count >= 5:
                    break

            assert chunk_count > 0
            assert total_bytes > 0

        finally:
            await client.close()


class TestFlextApiClientFactory:
    """Factory function tests."""

    def test_create_client_function(self) -> None:
        """Test create_client factory function."""
        client = create_client("https://httpbin.org", timeout=20.0, verify_ssl=True)

        assert isinstance(client, FlextApiClient)
        assert client.config.base_url == "https://httpbin.org"
        assert client.config.timeout == 20.0
        assert client.config.verify_ssl is True

    def test_create_client_with_plugins_function(self) -> None:
        """Test create_client_with_plugins factory function."""
        client = create_client_with_plugins(
            "https://httpbin.org",
            enable_cache=True,
            enable_retry=True,
            enable_circuit_breaker=False,
            timeout=15.0,
        )

        assert isinstance(client, FlextApiClient)
        assert len(client._plugins) == 2  # cache + retry, no circuit breaker

        plugin_names = [p.name for p in client._plugins]
        assert "CachingPlugin" in plugin_names
        assert "RetryPlugin" in plugin_names
        assert "CircuitBreakerPlugin" not in plugin_names


class TestFlextApiClientErrorHandling:
    """Error handling and edge cases."""

    @pytest.mark.asyncio
    async def test_timeout_handling(self) -> None:
        """Test request timeout handling."""
        client = create_client("https://httpbin.org", timeout=0.1)  # Very short timeout

        try:
            result = await client.get("/delay/2")  # 2 second delay endpoint

            # Should fail due to timeout
            assert not result.is_success
            assert "timeout" in result.error.lower() or "failed" in result.error.lower()

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_invalid_url_handling(self) -> None:
        """Test handling of invalid URLs."""
        client = create_client("https://nonexistent-domain-12345.com")

        try:
            result = await client.get("/test")

            # Should fail due to DNS resolution
            assert not result.is_success
            assert isinstance(result.error, str)

        finally:
            await client.close()

    @pytest.mark.asyncio
    async def test_session_management(self) -> None:
        """Test session creation and cleanup."""
        client = create_client("https://httpbin.org")

        # Initially no session
        assert client.get_session() is None

        # Session created on first request
        session = await client.ensure_session()
        assert isinstance(session, aiohttp.ClientSession)
        assert not session.closed

        # Same session returned
        session2 = await client.ensure_session()
        assert session is session2

        # Cleanup
        await client.close()
        assert client._status == FlextApiClientStatus.CLOSED
